<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webæ¤œç´¢çµæœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
            }
            50% { 
                opacity: 0.5; 
            }
        }
        
        .result-card {
            animation: slideIn 0.5s ease forwards;
        }
        
        .loading-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .screenshot-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { 
                background-position: 200% 0; 
            }
            100% { 
                background-position: -200% 0; 
            }
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50 h-full overflow-y-auto">
    <div id="app" class="p-4">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-lg shadow p-4 mb-4 sticky top-0 z-10">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="query-text">æ¤œç´¢å¾…æ©Ÿä¸­...</span>
                </h2>
                <div id="status-badge" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                    å¾…æ©Ÿä¸­
                </div>
            </div>
            
            <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div id="progress-container" class="hidden">
                <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span id="progress-text">æº–å‚™ä¸­...</span>
                    <span id="progress-count">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div id="current-site" class="text-xs text-gray-500 mt-1 truncate"></div>
            </div>
            
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div id="stats-container" class="hidden mt-3 grid grid-cols-3 gap-2 text-xs">
                <div class="bg-gray-50 rounded p-2 text-center">
                    <div class="text-gray-500">ã‚µã‚¤ãƒˆæ•°</div>
                    <div id="stats-sites" class="font-bold text-gray-800">0</div>
                </div>
                <div class="bg-gray-50 rounded p-2 text-center">
                    <div class="text-gray-500">ç·æ–‡å­—æ•°</div>
                    <div id="stats-text" class="font-bold text-gray-800">0</div>
                </div>
                <div class="bg-gray-50 rounded p-2 text-center">
                    <div class="text-gray-500">ç·ç”»åƒæ•°</div>
                    <div id="stats-images" class="font-bold text-gray-800">0</div>
                </div>
            </div>
        </div>
        
        <!-- åˆæœŸè¡¨ç¤ºï¼ˆå¾…æ©Ÿä¸­ï¼‰ -->
        <div id="waiting-container" class="bg-white rounded-lg shadow p-8 text-center">
            <div class="inline-block p-4 bg-blue-100 rounded-full mb-4 loading-pulse">
                <svg class="w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Webæ¤œç´¢ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†</h3>
            <p class="text-sm text-gray-600">AIãŒæ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã“ã“ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
        
        <!-- çµæœãƒªã‚¹ãƒˆ -->
        <div id="results-container" class="space-y-3 hidden">
            <!-- çµæœãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        
        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error-container" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center gap-2 text-red-700">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
                <span id="error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>
            </div>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let eventSource = null;
        let currentData = {
            query: '',
            results: [],
            screenshots: {},
            progress: { total: 0, completed: 0, current_site: '' },
            status: 'waiting'
        };
        
        // çµ±è¨ˆæƒ…å ±
        let stats = {
            totalText: 0,
            totalImages: 0
        };
        
        // åˆæœŸåŒ–
        function init() {
            // Server-Sent Eventsã®æ¥ç¶š
            connectEventSource();
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚’è©¦ã¿ã‚‹
            fetchInitialData();
        }
        
        // Server-Sent Eventsæ¥ç¶š
        function connectEventSource() {
            try {
                eventSource = new EventSource('/events');
                
                eventSource.onopen = function() {
                    console.log('SSE connection opened');
                    hideError();
                };
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        updateUI(data);
                    } catch (error) {
                        console.error('Failed to parse SSE data:', error);
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('SSE error:', error);
                    // å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
                    setTimeout(() => {
                        if (eventSource.readyState === EventSource.CLOSED) {
                            connectEventSource();
                        }
                    }, 5000);
                };
            } catch (error) {
                console.error('Failed to create EventSource:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒãƒ¼ãƒªãƒ³ã‚°
                startPolling();
            }
        }
        
        // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchInitialData() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.data) {
                        updateUI(data.data);
                    }
                }
            } catch (error) {
                console.error('Failed to fetch initial data:', error);
            }
        }
        
        // ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆSSEãŒä½¿ãˆãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        function startPolling() {
            setInterval(async () => {
                try {
                    const response = await fetch('/api/status');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data) {
                            updateUI(data.data);
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 1000);
        }
        
        // UIæ›´æ–°
        function updateUI(data) {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateStatus(data.status);
            
            // ã‚¯ã‚¨ãƒªæ›´æ–°
            if (data.query && data.query !== currentData.query) {
                document.getElementById('query-text').textContent = `æ¤œç´¢: ${data.query}`;
                currentData.query = data.query;
                
                // å¾…æ©Ÿç”»é¢ã‚’éè¡¨ç¤ºã€çµæœã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
                document.getElementById('waiting-container').classList.add('hidden');
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('progress-container').classList.remove('hidden');
                document.getElementById('stats-container').classList.remove('hidden');
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
            if (data.progress) {
                updateProgress(data.progress);
                currentData.progress = data.progress;
            }
            
            // æ–°ã—ã„çµæœã‚’è¿½åŠ 
            if (data.results && data.results.length > currentData.results.length) {
                const container = document.getElementById('results-container');
                
                for (let i = currentData.results.length; i < data.results.length; i++) {
                    const result = data.results[i];
                    const card = createResultCard(result, i, data.screenshots);
                    container.appendChild(card);
                    
                    // çµ±è¨ˆæ›´æ–°
                    stats.totalText += result.text_length || 0;
                    stats.totalImages += result.image_count || 0;
                    updateStats(data.results.length);
                }
                
                currentData.results = data.results;
            }
            
            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ›´æ–°
            if (data.screenshots) {
                Object.keys(data.screenshots).forEach(key => {
                    if (!currentData.screenshots[key]) {
                        const index = key.replace('screenshot_', '');
                        updateScreenshot(index);
                    }
                });
                currentData.screenshots = data.screenshots;
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå®Œäº†ã®å ´åˆ
            if (data.status === 'completed') {
                document.getElementById('progress-container').classList.add('opacity-50');
                updateStatus('completed');
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸æ›´æ–°
        function updateStatus(status) {
            const badge = document.getElementById('status-badge');
            const statusMap = {
                'waiting': { text: 'å¾…æ©Ÿä¸­', class: 'bg-gray-100 text-gray-600' },
                'searching': { text: 'æ¤œç´¢ä¸­', class: 'bg-yellow-100 text-yellow-700' },
                'scraping': { text: 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­', class: 'bg-blue-100 text-blue-700' },
                'completed': { text: 'å®Œäº†', class: 'bg-green-100 text-green-700' },
                'error': { text: 'ã‚¨ãƒ©ãƒ¼', class: 'bg-red-100 text-red-700' }
            };
            
            const statusInfo = statusMap[status] || statusMap['waiting'];
            badge.textContent = statusInfo.text;
            badge.className = `px-2 py-1 text-xs rounded-full ${statusInfo.class}`;
        }
        
        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress(progress) {
            const percentage = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-count').textContent = `${progress.completed}/${progress.total}`;
            document.getElementById('progress-text').textContent = 
                progress.completed === progress.total ? 'å®Œäº†' : 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­...';
            
            if (progress.current_site) {
                document.getElementById('current-site').textContent = `å‡¦ç†ä¸­: ${progress.current_site}`;
            }
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats(siteCount) {
            document.getElementById('stats-sites').textContent = siteCount;
            document.getElementById('stats-text').textContent = stats.totalText.toLocaleString();
            document.getElementById('stats-images').textContent = stats.totalImages;
        }
        
        // çµæœã‚«ãƒ¼ãƒ‰ä½œæˆ
        function createResultCard(result, index, screenshots) {
            const card = document.createElement('div');
            card.className = 'result-card bg-white rounded-lg shadow p-4';
            card.style.animationDelay = `${index * 0.1}s`;
            
            const hasScreenshot = screenshots && screenshots[`screenshot_${index}`];
            
            card.innerHTML = `
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-32 h-24 bg-gray-200 rounded overflow-hidden">
                        <div id="screenshot-container-${index}">
                            ${hasScreenshot ? 
                                `<img src="/screenshot/${index}" class="w-full h-full object-cover" alt="Screenshot">` :
                                `<div class="w-full h-24 screenshot-skeleton"></div>`
                            }
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-semibold text-sm mb-1 truncate" title="${escapeHtml(result.title)}">
                            ${escapeHtml(result.title)}
                        </h3>
                        <a href="${result.url}" target="_blank" class="text-xs text-blue-600 hover:underline truncate block mb-2" title="${result.url}">
                            ${result.url}
                        </a>
                        <div class="flex items-center gap-3 text-xs text-gray-600">
                            <span title="ãƒ†ã‚­ã‚¹ãƒˆé‡">ğŸ“ ${(result.text_length || 0).toLocaleString()}æ–‡å­—</span>
                            <span title="ç”»åƒæ•°">ğŸ–¼ï¸ ${result.image_count || 0}ç”»åƒ</span>
                            ${result.success ? 
                                '<span class="text-green-600" title="æˆåŠŸ">âœ…</span>' : 
                                '<span class="text-red-600" title="å¤±æ•—">âŒ</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ›´æ–°
        function updateScreenshot(index) {
            const container = document.getElementById(`screenshot-container-${index}`);
            if (container) {
                container.innerHTML = `
                    <img src="/screenshot/${index}" class="w-full h-full object-cover" alt="Screenshot" 
                         onload="this.style.opacity='0'; setTimeout(() => this.style.opacity='1', 50);"
                         style="transition: opacity 0.3s;">
                `;
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }
        
        // ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
        function hideError() {
            document.getElementById('error-container').classList.add('hidden');
        }
        
        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', init);
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«SSEæ¥ç¶šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
