================================================================================
                         ã‚µãƒãƒ¼ã‚¿ãƒ¼é–‹ç™ºãƒ«ãƒ¼ãƒ« v1.0
================================================================================

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‚’é–‹ç™ºã™ã‚‹éš›ã®ãƒ«ãƒ¼ãƒ«ã¨ä»•æ§˜ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆã™ã‚‹å‰ã«å¿…ãšã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

================================================================================
ç›®æ¬¡
================================================================================

1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
2. manifest.json ã®ä»•æ§˜
3. ã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä»•æ§˜
4. executeé–¢æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
5. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆcontextï¼‰ã®è©³ç´°
6. æˆ»ã‚Šå€¤ã®è©³ç´°
7. AIHelper ã®ä½¿ã„æ–¹
8. output_scope ã®å‹•ä½œ
9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
10. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
11. ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

================================================================================
1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
================================================================================

ã‚µãƒãƒ¼ã‚¿ãƒ¼ã¯ä»¥ä¸‹ã®æ§‹æˆã§ä½œæˆã—ã¦ãã ã•ã„ï¼š

supporter/
â””â”€â”€ [supporter_name]/              # ã‚µãƒãƒ¼ã‚¿ãƒ¼åï¼ˆsnake_caseï¼‰
    â”œâ”€â”€ manifest.json              # å¿…é ˆ: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
    â”œâ”€â”€ [supporter_name]_supporter.py  # å¿…é ˆ: ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    â”œâ”€â”€ requirements.txt           # ä»»æ„: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
    â””â”€â”€ ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«            # ä»»æ„: è£œåŠ©ãƒ•ã‚¡ã‚¤ãƒ«

ä¾‹ï¼š
supporter/
â””â”€â”€ rag_search/
    â”œâ”€â”€ manifest.json
    â”œâ”€â”€ rag_search_supporter.py
    â”œâ”€â”€ requirements.txt
    â””â”€â”€ vector_store.py

é‡è¦ï¼š
- ãƒ•ã‚©ãƒ«ãƒ€åã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã¯ä¸€è‡´ã•ã›ã‚‹ã“ã¨
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã¯å¿…ãšã€Œ{ãƒ•ã‚©ãƒ«ãƒ€å}_supporter.pyã€ã¨ã™ã‚‹ã“ã¨
- ãƒ•ã‚©ãƒ«ãƒ€åã¯ snake_case ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
- å…ˆé ­ãŒã€Œ_ã€ã¾ãŸã¯ã€Œ.ã€ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯ç„¡è¦–ã•ã‚Œã‚‹

================================================================================
2. manifest.json ã®ä»•æ§˜
================================================================================

manifest.json ã¯ã‚µãƒãƒ¼ã‚¿ãƒ¼ã®è¨­å®šã‚’å®šç¾©ã™ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

------------------------------------------------------------------------------
2.1 å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
------------------------------------------------------------------------------

{
    "name": "ã‚µãƒãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºå",
    "description": "ã‚µãƒãƒ¼ã‚¿ãƒ¼ã®èª¬æ˜æ–‡",
    "version": "1.0.0",
    "timing": "pre",
    "output_scope": "turn"
}

------------------------------------------------------------------------------
2.2 å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§
------------------------------------------------------------------------------

{
    "name": "string",           # å¿…é ˆ: UIè¡¨ç¤ºå
    "description": "string",    # å¿…é ˆ: èª¬æ˜æ–‡
    "version": "string",        # å¿…é ˆ: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆsemveræ¨å¥¨ï¼‰
    "timing": "string",         # å¿…é ˆ: å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
    "output_scope": "string",   # å¿…é ˆ: å‡ºåŠ›ã‚¹ã‚³ãƒ¼ãƒ—
    "enabled": boolean,         # ä»»æ„: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ‰åŠ¹çŠ¶æ…‹ï¼ˆdefault: trueï¼‰
    "icon": "string",           # ä»»æ„: çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆdefault: "ğŸ”§"ï¼‰
    "ai_config": object,        # ä»»æ„: AIæ©Ÿèƒ½è¨­å®š
    "settings_schema": object   # ä»»æ„: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚¹ã‚­ãƒ¼ãƒ
}

------------------------------------------------------------------------------
2.3 timing ã®å€¤
------------------------------------------------------------------------------

| å€¤     | èª¬æ˜                                           |
|--------|------------------------------------------------|
| "pre"  | AIå¿œç­”ç”Ÿæˆã®å‰ã«å®Ÿè¡Œï¼ˆå…¥åŠ›ã®åŠ å·¥ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ï¼‰|
| "post" | AIå¿œç­”ç”Ÿæˆã®å¾Œã«å®Ÿè¡Œï¼ˆå¿œç­”ã®ä¿®æ­£ã€æ¤œé–²ï¼‰         |
| "both" | å‰å¾Œä¸¡æ–¹ã§å®Ÿè¡Œ                                  |

------------------------------------------------------------------------------
2.4 output_scope ã®å€¤
------------------------------------------------------------------------------

| å€¤          | èª¬æ˜                                         |
|-------------|----------------------------------------------|
| "permanent" | history.jsonã«æ°¸ç¶šä¿å­˜                        |
| "turn"      | ReActãƒ«ãƒ¼ãƒ—çµ‚äº†ã¾ã§ç¶­æŒã€ãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œã«ç ´æ£„    |
| "temporary" | ãã®å‡¦ç†å†…ã§ã®ã¿æœ‰åŠ¹ã€å³åº§ã«ç ´æ£„              |

------------------------------------------------------------------------------
2.5 ai_config ã®æ§‹é€ 
------------------------------------------------------------------------------

AIæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã«è¨­å®šã—ã¾ã™ã€‚

{
    "ai_config": {
        "mode": "fixed" | "current" | "user",
        "model_id": "gemini-2.5-flash"  // mode="fixed"ã®å ´åˆã®ã¿å¿…é ˆ
    }
}

| mode      | èª¬æ˜                                    |
|-----------|-----------------------------------------|
| "fixed"   | model_idã§æŒ‡å®šã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’å›ºå®šä½¿ç”¨        |
| "current" | ãƒãƒ£ãƒƒãƒˆã§ä½¿ç”¨ä¸­ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨            |
| "user"    | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒUIã§é¸æŠã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨        |

------------------------------------------------------------------------------
2.6 settings_schema ã®æ§‹é€ 
------------------------------------------------------------------------------

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒUIã§å¤‰æ›´ã§ãã‚‹è¨­å®šã‚’å®šç¾©ã—ã¾ã™ã€‚

{
    "settings_schema": {
        "setting_key": {
            "type": "boolean" | "number" | "string" | "select",
            "label": "è¨­å®šã®è¡¨ç¤ºå",
            "description": "è¨­å®šã®èª¬æ˜",
            "default": ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤,
            
            // type="number"ã®å ´åˆ
            "min": 0,
            "max": 100,
            "step": 1,
            
            // type="select"ã®å ´åˆ
            "options": [
                {"value": "option1", "label": "ã‚ªãƒ—ã‚·ãƒ§ãƒ³1"},
                {"value": "option2", "label": "ã‚ªãƒ—ã‚·ãƒ§ãƒ³2"}
            ]
        }
    }
}

------------------------------------------------------------------------------
2.7 manifest.json ã®å®Œå…¨ãªä¾‹
------------------------------------------------------------------------------

{
    "name": "RAGæ¤œç´¢ã‚µãƒãƒ¼ã‚¿ãƒ¼",
    "description": "é–¢é€£æ–‡æ›¸ã‚’æ¤œç´¢ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™",
    "version": "1.0.0",
    "timing": "pre",
    "output_scope": "turn",
    "enabled": true,
    "icon": "ğŸ”",
    "ai_config": {
        "mode": "current"
    },
    "settings_schema": {
        "max_results": {
            "type": "number",
            "label": "æœ€å¤§æ¤œç´¢çµæœæ•°",
            "description": "æ¤œç´¢ã§å–å¾—ã™ã‚‹æœ€å¤§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°",
            "default": 5,
            "min": 1,
            "max": 20,
            "step": 1
        },
        "similarity_threshold": {
            "type": "number",
            "label": "é¡ä¼¼åº¦é–¾å€¤",
            "description": "ã“ã®å€¤ä»¥ä¸Šã®é¡ä¼¼åº¦ã‚’æŒã¤çµæœã®ã¿è¿”ã—ã¾ã™",
            "default": 0.7,
            "min": 0.0,
            "max": 1.0,
            "step": 0.1
        },
        "include_metadata": {
            "type": "boolean",
            "label": "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹",
            "description": "æ¤œç´¢çµæœã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹ã‹",
            "default": true
        }
    }
}

================================================================================
3. ã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä»•æ§˜
================================================================================

------------------------------------------------------------------------------
3.1 ãƒ•ã‚¡ã‚¤ãƒ«åã®è¦å‰‡
------------------------------------------------------------------------------

ãƒ•ã‚¡ã‚¤ãƒ«åã¯å¿…ãšä»¥ä¸‹ã®å½¢å¼ã«ã—ã¦ãã ã•ã„ï¼š

    {ãƒ•ã‚©ãƒ«ãƒ€å}_supporter.py

ä¾‹ï¼š
- ãƒ•ã‚©ãƒ«ãƒ€åãŒã€Œrag_searchã€ã®å ´åˆ â†’ rag_search_supporter.py
- ãƒ•ã‚©ãƒ«ãƒ€åãŒã€Œcontent_filterã€ã®å ´åˆ â†’ content_filter_supporter.py

------------------------------------------------------------------------------
3.2 å¿…é ˆé–¢æ•°
------------------------------------------------------------------------------

ã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¯ä»¥ä¸‹ã®é–¢æ•°ãŒå¿…é ˆã§ã™ï¼š

def execute(context: dict) -> dict:
    """
    ã‚µãƒãƒ¼ã‚¿ãƒ¼ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
    
    Args:
        context: å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè©³ç´°ã¯å¾Œè¿°ï¼‰
    
    Returns:
        å‡¦ç†çµæœã®è¾æ›¸ï¼ˆè©³ç´°ã¯å¾Œè¿°ï¼‰
    """
    pass

------------------------------------------------------------------------------
3.3 ä»»æ„é–¢æ•°
------------------------------------------------------------------------------

ä»¥ä¸‹ã®é–¢æ•°ã¯ä»»æ„ã§å®Ÿè£…ã§ãã¾ã™ï¼š

def initialize() -> None:
    """ã‚µãƒãƒ¼ã‚¿ãƒ¼èª­ã¿è¾¼ã¿æ™‚ã«ä¸€åº¦ã ã‘å‘¼ã°ã‚Œã‚‹åˆæœŸåŒ–å‡¦ç†"""
    pass

def cleanup() -> None:
    """ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã«å‘¼ã°ã‚Œã‚‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†"""
    pass

================================================================================
4. executeé–¢æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
================================================================================

------------------------------------------------------------------------------
4.1 é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£
------------------------------------------------------------------------------

def execute(context: dict) -> dict:

------------------------------------------------------------------------------
4.2 å¼•æ•° context ã®æ§‹é€ 
------------------------------------------------------------------------------

context = {
    # === åŸºæœ¬æƒ…å ± ===
    'timing': str,              # 'pre' ã¾ãŸã¯ 'post'
    'chat_id': str,             # ãƒãƒ£ãƒƒãƒˆID
    'current_model_id': str,    # ç¾åœ¨ä½¿ç”¨ä¸­ã®ãƒ¢ãƒ‡ãƒ«ID
    
    # === å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ ===
    'user_input': str,          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
    'history': dict,            # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆæ¨™æº–å½¢å¼ï¼‰
    
    # === Postæ™‚ã®ã¿ ===
    'ai_response': str,         # AIã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆï¼ˆtiming='post'æ™‚ã®ã¿ï¼‰
    
    # === ã‚¹ã‚³ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ ===
    'turn_data': dict,          # turnã‚¹ã‚³ãƒ¼ãƒ—ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå‰ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã®å¼•ãç¶™ãï¼‰
    
    # === è¨­å®š ===
    'settings': dict,           # ã‚µãƒãƒ¼ã‚¿ãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
    'supporter_settings': dict, # ãƒãƒ£ãƒƒãƒˆã”ã¨ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼è¨­å®š
    
    # === AIæ©Ÿèƒ½ï¼ˆai_configè¨­å®šæ™‚ã®ã¿ï¼‰ ===
    'ai_helper': AIHelper,      # AIãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
}

------------------------------------------------------------------------------
4.3 æˆ»ã‚Šå€¤ã®æ§‹é€ 
------------------------------------------------------------------------------

return {
    # === Preæ™‚ã®å‡ºåŠ› ===
    'modified_input': str,      # ä¿®æ­£ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆä»»æ„ï¼‰
    'context_additions': str,   # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰
    
    # === Postæ™‚ã®å‡ºåŠ› ===
    'modified_response': str,   # ä¿®æ­£ã•ã‚ŒãŸAIå¿œç­”ï¼ˆä»»æ„ï¼‰
    
    # === ã‚¹ã‚³ãƒ¼ãƒ—ãƒ‡ãƒ¼ã‚¿ ===
    'turn_data': dict,          # turnã‚¹ã‚³ãƒ¼ãƒ—ã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆä»»æ„ï¼‰
    'permanent_data': dict,     # æ°¸ç¶šä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆä»»æ„ï¼‰
    
    # === ã‚¨ãƒ©ãƒ¼ ===
    'error': str,               # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ï¼‰
}

================================================================================
5. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆcontextï¼‰ã®è©³ç´°
================================================================================

------------------------------------------------------------------------------
5.1 timing
------------------------------------------------------------------------------

ç¾åœ¨ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç¤ºã™æ–‡å­—åˆ—ã€‚

- 'pre': AIå¿œç­”ç”Ÿæˆå‰
- 'post': AIå¿œç­”ç”Ÿæˆå¾Œ

manifest.jsonã§timing="both"ã‚’æŒ‡å®šã—ãŸå ´åˆã€executeé–¢æ•°ã¯2å›å‘¼ã°ã‚Œã¾ã™ã€‚
context['timing']ã‚’ç¢ºèªã—ã¦å‡¦ç†ã‚’åˆ†å²ã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
def execute(context: dict) -> dict:
    if context['timing'] == 'pre':
        return handle_pre(context)
    else:
        return handle_post(context)

------------------------------------------------------------------------------
5.2 user_input
------------------------------------------------------------------------------

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã€‚

Preæ™‚ï¼šå…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€ã¾ãŸã¯å‰ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ãŒä¿®æ­£ã—ãŸå…¥åŠ›
Postæ™‚ï¼šå…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›

------------------------------------------------------------------------------
5.3 ai_responseï¼ˆPostæ™‚ã®ã¿ï¼‰
------------------------------------------------------------------------------

AIãŒç”Ÿæˆã—ãŸå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã€‚

Preæ™‚ï¼šå­˜åœ¨ã—ãªã„ï¼ˆã‚­ãƒ¼ãŒãªã„ã‹ã€Noneã®å¯èƒ½æ€§ã‚ã‚Šï¼‰
Postæ™‚ï¼šAIã®å¿œç­”ã€ã¾ãŸã¯å‰ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ãŒä¿®æ­£ã—ãŸå¿œç­”

------------------------------------------------------------------------------
5.4 history
------------------------------------------------------------------------------

ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆæ¨™æº–å½¢å¼ schema_version 2.0ï¼‰ã€‚

{
    "conversation_id": "uuid",
    "title": "ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒˆãƒ«",
    "schema_version": "2.0",
    "messages": [...],
    "mapping": {...},
    "current_node": "msg-xxx"
}

æ³¨æ„ï¼šhistoryã¯èª­ã¿å–ã‚Šå°‚ç”¨ã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„ã€‚
ç›´æ¥å¤‰æ›´ã—ã¦ã‚‚ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚

------------------------------------------------------------------------------
5.5 turn_data
------------------------------------------------------------------------------

turnã‚¹ã‚³ãƒ¼ãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã€‚ReActãƒ«ãƒ¼ãƒ—å†…ã§è¤‡æ•°ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™ã€‚

- å‰ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ãŒè¨­å®šã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Œã‚‹
- è¨­å®šã—ãŸãƒ‡ãƒ¼ã‚¿ã¯æ¬¡ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ã«å¼•ãç¶™ãŒã‚Œã‚‹
- ReActãƒ«ãƒ¼ãƒ—çµ‚äº†æ™‚ã«ç ´æ£„ã•ã‚Œã‚‹

ä¾‹ï¼š
def execute(context: dict) -> dict:
    turn_data = context.get('turn_data', {})
    
    # å‰ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã‚€
    previous_result = turn_data.get('search_results', [])
    
    # æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    turn_data['my_data'] = {'key': 'value'}
    
    return {'turn_data': turn_data}

------------------------------------------------------------------------------
5.6 settings
------------------------------------------------------------------------------

manifest.jsonã®settings_schemaã§å®šç¾©ã—ãŸè¨­å®šã®ç¾åœ¨å€¤ã€‚

ä¾‹ï¼š
settings_schema = {
    "max_results": {"type": "number", "default": 5}
}

context['settings'] = {
    "max_results": 10  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´ã—ãŸå€¤ã€ã¾ãŸã¯5ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
}

================================================================================
6. æˆ»ã‚Šå€¤ã®è©³ç´°
================================================================================

------------------------------------------------------------------------------
6.1 modified_inputï¼ˆPreæ™‚ï¼‰
------------------------------------------------------------------------------

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ä¿®æ­£ã™ã‚‹å ´åˆã«è¨­å®šã—ã¾ã™ã€‚

- è¨­å®šã—ãªã„å ´åˆï¼šå…¥åŠ›ã¯å¤‰æ›´ã•ã‚Œãªã„
- è¨­å®šã—ãŸå ´åˆï¼šä»¥é™ã®å‡¦ç†ã§ã¯ä¿®æ­£ã•ã‚ŒãŸå…¥åŠ›ãŒä½¿ç”¨ã•ã‚Œã‚‹

ä¾‹ï¼š
def execute(context: dict) -> dict:
    user_input = context['user_input']
    enhanced_input = f"{user_input}\n\n[è¿½åŠ æƒ…å ±: ...]"
    return {'modified_input': enhanced_input}

------------------------------------------------------------------------------
6.2 context_additionsï¼ˆPreæ™‚ï¼‰
------------------------------------------------------------------------------

ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã€‚

- AIã¸ã®è¿½åŠ æŒ‡ç¤ºã‚„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’æ¸¡ã™ã®ã«ä½¿ç”¨
- è¤‡æ•°ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ãŒè¨­å®šã—ãŸå ´åˆã€ã™ã¹ã¦çµåˆã•ã‚Œã‚‹

ä¾‹ï¼š
def execute(context: dict) -> dict:
    return {
        'context_additions': """
## è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
ä»¥ä¸‹ã®é–¢é€£æƒ…å ±ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼š
- æƒ…å ±1
- æƒ…å ±2
"""
    }

------------------------------------------------------------------------------
6.3 modified_responseï¼ˆPostæ™‚ï¼‰
------------------------------------------------------------------------------

AIå¿œç­”ã‚’ä¿®æ­£ã™ã‚‹å ´åˆã«è¨­å®šã—ã¾ã™ã€‚

- è¨­å®šã—ãªã„å ´åˆï¼šå¿œç­”ã¯å¤‰æ›´ã•ã‚Œãªã„
- è¨­å®šã—ãŸå ´åˆï¼šä»¥é™ã®å‡¦ç†ã§ã¯ä¿®æ­£ã•ã‚ŒãŸå¿œç­”ãŒä½¿ç”¨ã•ã‚Œã‚‹

ä¾‹ï¼š
def execute(context: dict) -> dict:
    response = context['ai_response']
    # ä¸é©åˆ‡ãªå†…å®¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    filtered = filter_inappropriate(response)
    return {'modified_response': filtered}

------------------------------------------------------------------------------
6.4 turn_data
------------------------------------------------------------------------------

turnã‚¹ã‚³ãƒ¼ãƒ—ã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€‚

- è¾æ›¸å½¢å¼ã§æŒ‡å®š
- æ—¢å­˜ã®turn_dataã¨ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹
- ReActãƒ«ãƒ¼ãƒ—çµ‚äº†æ™‚ã«ç ´æ£„ã•ã‚Œã‚‹

ä¾‹ï¼š
return {
    'turn_data': {
        'search_performed': True,
        'results_count': 5
    }
}

------------------------------------------------------------------------------
6.5 permanent_data
------------------------------------------------------------------------------

æ°¸ç¶šä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€‚

- history.jsonã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã•ã‚Œã‚‹
- ãƒãƒ£ãƒƒãƒˆã‚’å†åº¦é–‹ã„ãŸæ™‚ã«ã‚‚å‚ç…§å¯èƒ½

æ³¨æ„ï¼šå¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã—ã¾ã™ã€‚

ä¾‹ï¼š
return {
    'permanent_data': {
        'last_search_query': 'example query',
        'timestamp': time.time()
    }
}

------------------------------------------------------------------------------
6.6 error
------------------------------------------------------------------------------

ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã«è¨­å®šã—ã¾ã™ã€‚

- errorã‚’è¨­å®šã™ã‚‹ã¨ã€ä»–ã®æˆ»ã‚Šå€¤ã¯ç„¡è¦–ã•ã‚Œã‚‹
- ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã€å‡¦ç†ã¯æ¬¡ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ã«ç¶šè¡Œã•ã‚Œã‚‹

ä¾‹ï¼š
return {'error': 'APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'}

================================================================================
7. AIHelper ã®ä½¿ã„æ–¹
================================================================================

manifest.jsonã§ai_configã‚’è¨­å®šã™ã‚‹ã¨ã€context['ai_helper']ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

------------------------------------------------------------------------------
7.1 åŸºæœ¬çš„ãªä½¿ã„æ–¹
------------------------------------------------------------------------------

def execute(context: dict) -> dict:
    ai_helper = context.get('ai_helper')
    
    if ai_helper is None:
        return {'error': 'AIæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“'}
    
    # ã‚·ãƒ³ãƒ—ãƒ«ãªå•ã„åˆã‚ã›
    response = ai_helper.get_response(
        system_prompt="ã‚ãªãŸã¯è¦ç´„ã®å°‚é–€å®¶ã§ã™ã€‚",
        user_message="ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„ã—ã¦ãã ã•ã„ï¼š..."
    )
    
    return {'context_additions': f"è¦ç´„çµæœ: {response}"}

------------------------------------------------------------------------------
7.2 get_response ãƒ¡ã‚½ãƒƒãƒ‰
------------------------------------------------------------------------------

ai_helper.get_response(system_prompt: str, user_message: str) -> str

manifest.jsonã®ai_configã§è¨­å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦AIå¿œç­”ã‚’å–å¾—ã—ã¾ã™ã€‚

å¼•æ•°ï¼š
- system_prompt: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- user_message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

æˆ»ã‚Šå€¤ï¼š
- AIã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ

ä¾‹å¤–ï¼š
- RuntimeError: AIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ãŸå ´åˆ

------------------------------------------------------------------------------
7.3 get_response_with_model ãƒ¡ã‚½ãƒƒãƒ‰
------------------------------------------------------------------------------

ai_helper.get_response_with_model(
    model_id: str,
    system_prompt: str,
    user_message: str
) -> str

æŒ‡å®šã—ãŸãƒ¢ãƒ‡ãƒ«IDã§AIå¿œç­”ã‚’å–å¾—ã—ã¾ã™ã€‚

å¼•æ•°ï¼š
- model_id: ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«IDï¼ˆä¾‹: "gemini-2.5-flash"ï¼‰
- system_prompt: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
- user_message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

æˆ»ã‚Šå€¤ï¼š
- AIã®å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ

------------------------------------------------------------------------------
7.4 list_available_models ãƒ¡ã‚½ãƒƒãƒ‰
------------------------------------------------------------------------------

ai_helper.list_available_models() -> List[Dict]

åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã®ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

æˆ»ã‚Šå€¤ï¼š
[
    {
        "id": "gemini-2.5-flash",
        "name": "Gemini 2.5 Flash",
        "provider": "gemini",
        ...
    },
    ...
]

------------------------------------------------------------------------------
7.5 è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã¸ã®å•ã„åˆã‚ã›ä¾‹
------------------------------------------------------------------------------

def execute(context: dict) -> dict:
    ai_helper = context.get('ai_helper')
    if not ai_helper:
        return {}
    
    # Geminiãƒ¢ãƒ‡ãƒ«ã‚’ã™ã¹ã¦å–å¾—
    models = ai_helper.list_available_models()
    gemini_models = [m for m in models if 'gemini' in m['id'].lower()]
    
    # å„ãƒ¢ãƒ‡ãƒ«ã«å•ã„åˆã‚ã›
    responses = {}
    for model in gemini_models[:3]:  # æœ€å¤§3ã¤
        try:
            resp = ai_helper.get_response_with_model(
                model_id=model['id'],
                system_prompt="ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚",
                user_message=context['user_input']
            )
            responses[model['id']] = resp
        except Exception as e:
            responses[model['id']] = f"Error: {e}"
    
    # çµæœã‚’çµ±åˆ
    summary = "\n".join([f"[{k}]: {v}" for k, v in responses.items()])
    
    return {'context_additions': f"è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã®å›ç­”:\n{summary}"}

================================================================================
8. output_scope ã®å‹•ä½œ
================================================================================

------------------------------------------------------------------------------
8.1 temporary
------------------------------------------------------------------------------

- ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨ã®å‡¦ç†å†…ã§ã®ã¿æœ‰åŠ¹
- executeé–¢æ•°ã®æˆ»ã‚Šå€¤ã¯å‡¦ç†ã«ä½¿ç”¨ã•ã‚Œã‚‹ãŒã€ä¿å­˜ã•ã‚Œãªã„
- æœ€ã‚‚è»½é‡

ä½¿ç”¨ä¾‹ï¼š
- ä¸€æ™‚çš„ãªè¨ˆç®—çµæœ
- ãã®å ´é™ã‚Šã®å¤‰æ›

------------------------------------------------------------------------------
8.2 turn
------------------------------------------------------------------------------

- ãƒ‡ãƒ¼ã‚¿ã¯ReActãƒ«ãƒ¼ãƒ—çµ‚äº†ã¾ã§ç¶­æŒ
- turn_dataã‚’é€šã˜ã¦ä»–ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿å…±æœ‰å¯èƒ½
- ãƒ«ãƒ¼ãƒ—çµ‚äº†æ™‚ã«ç ´æ£„

ä½¿ç”¨ä¾‹ï¼š
- RAGæ¤œç´¢çµæœï¼ˆåŒã˜ãƒ«ãƒ¼ãƒ—å†…ã§å‚ç…§ï¼‰
- ä¸­é–“å‡¦ç†çµæœ

------------------------------------------------------------------------------
8.3 permanent
------------------------------------------------------------------------------

- ãƒ‡ãƒ¼ã‚¿ã¯history.jsonã«æ°¸ç¶šä¿å­˜
- ãƒãƒ£ãƒƒãƒˆã‚’å†åº¦é–‹ã„ãŸæ™‚ã«ã‚‚å‚ç…§å¯èƒ½
- permanent_dataã§æŒ‡å®šã—ãŸãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿å­˜

ä½¿ç”¨ä¾‹ï¼š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿å­¦ç¿’çµæœ
- é‡è¦ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

================================================================================
9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
================================================================================

------------------------------------------------------------------------------
9.1 åŸºæœ¬æ–¹é‡
------------------------------------------------------------------------------

- ã‚µãƒãƒ¼ã‚¿ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ãƒ¡ã‚¤ãƒ³å‡¦ç†ã¯ç¶šè¡Œã•ã‚Œã‚‹
- ã‚¨ãƒ©ãƒ¼ã¯ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥ã•ã‚Œãªã„ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•—ï¼‰

------------------------------------------------------------------------------
9.2 ã‚¨ãƒ©ãƒ¼ã®å ±å‘Šæ–¹æ³•
------------------------------------------------------------------------------

æ–¹æ³•1: error ã‚­ãƒ¼ã‚’è¿”ã™
def execute(context: dict) -> dict:
    if some_error_condition:
        return {'error': 'ã‚¨ãƒ©ãƒ¼ã®èª¬æ˜'}
    ...

æ–¹æ³•2: ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹ï¼ˆéæ¨å¥¨ï¼‰
def execute(context: dict) -> dict:
    raise ValueError("ã‚¨ãƒ©ãƒ¼ã®èª¬æ˜")
    # â†’ ã‚­ãƒ£ãƒƒãƒã•ã‚Œã¦ãƒ­ã‚°ã«è¨˜éŒ²ã€å‡¦ç†ã¯ç¶šè¡Œ

------------------------------------------------------------------------------
9.3 æ¨å¥¨ã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
------------------------------------------------------------------------------

def execute(context: dict) -> dict:
    try:
        # ãƒ¡ã‚¤ãƒ³å‡¦ç†
        result = do_something()
        return {'context_additions': result}
    
    except SpecificError as e:
        # äºˆæœŸã•ã‚Œã‚‹ã‚¨ãƒ©ãƒ¼
        return {'error': f'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}'}
    
    except Exception as e:
        # äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
        import traceback
        traceback.print_exc()
        return {'error': f'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: {e}'}

================================================================================
10. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
================================================================================

------------------------------------------------------------------------------
10.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
------------------------------------------------------------------------------

- é‡ã„åˆæœŸåŒ–å‡¦ç†ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ä¸€åº¦ã ã‘å®Ÿè¡Œ
- å¤§ããªãƒ‡ãƒ¼ã‚¿ã¯permanent_dataã«ä¿å­˜ã—ãªã„
- AIå‘¼ã³å‡ºã—ã¯å¿…è¦æœ€å°é™ã«

æ‚ªã„ä¾‹ï¼š
def execute(context: dict) -> dict:
    import heavy_library  # æ¯å›ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    model = load_model()   # æ¯å›ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
    ...

è‰¯ã„ä¾‹ï¼š
import heavy_library  # ä¸€åº¦ã ã‘

_model = None
def get_model():
    global _model
    if _model is None:
        _model = load_model()
    return _model

def execute(context: dict) -> dict:
    model = get_model()
    ...

------------------------------------------------------------------------------
10.2 timing="both"ã®å‡¦ç†
------------------------------------------------------------------------------

def execute(context: dict) -> dict:
    timing = context['timing']
    
    if timing == 'pre':
        # Preå‡¦ç†
        return handle_pre(context)
    elif timing == 'post':
        # Postå‡¦ç†
        return handle_post(context)
    
    return {}

def handle_pre(context: dict) -> dict:
    ...

def handle_post(context: dict) -> dict:
    ...

------------------------------------------------------------------------------
10.3 è¨­å®šã®æ¤œè¨¼
------------------------------------------------------------------------------

def execute(context: dict) -> dict:
    settings = context.get('settings', {})
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    max_results = settings.get('max_results', 5)
    threshold = settings.get('threshold', 0.7)
    
    # ç¯„å›²ãƒã‚§ãƒƒã‚¯
    max_results = max(1, min(20, max_results))
    threshold = max(0.0, min(1.0, threshold))
    
    ...

------------------------------------------------------------------------------
10.4 ãƒ­ã‚°å‡ºåŠ›
------------------------------------------------------------------------------

def execute(context: dict) -> dict:
    chat_id = context.get('chat_id', 'unknown')
    
    print(f"[MySurpporter] Processing chat: {chat_id}")
    
    # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    if os.environ.get('DEBUG'):
        print(f"[MySurpporter] Input: {context['user_input'][:100]}...")
    
    ...

================================================================================
11. ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
================================================================================

------------------------------------------------------------------------------
11.1 æœ€å°é™ã®ã‚µãƒãƒ¼ã‚¿ãƒ¼
------------------------------------------------------------------------------

# simple_supporter/manifest.json
{
    "name": "ã‚·ãƒ³ãƒ—ãƒ«ã‚µãƒãƒ¼ã‚¿ãƒ¼",
    "description": "å…¥åŠ›ã«æŒ¨æ‹¶ã‚’è¿½åŠ ã—ã¾ã™",
    "version": "1.0.0",
    "timing": "pre",
    "output_scope": "temporary",
    "icon": "ğŸ‘‹"
}

# simple_supporter/simple_supporter_supporter.py
def execute(context: dict) -> dict:
    user_input = context.get('user_input', '')
    modified = f"ã“ã‚“ã«ã¡ã¯ï¼\n\n{user_input}"
    return {'modified_input': modified}

------------------------------------------------------------------------------
11.2 AIæ©Ÿèƒ½ã‚’ä½¿ã†ã‚µãƒãƒ¼ã‚¿ãƒ¼
------------------------------------------------------------------------------

# summarizer/manifest.json
{
    "name": "è¦ç´„ã‚µãƒãƒ¼ã‚¿ãƒ¼",
    "description": "é•·ã„å…¥åŠ›ã‚’è¦ç´„ã—ã¦ã‹ã‚‰AIã«æ¸¡ã—ã¾ã™",
    "version": "1.0.0",
    "timing": "pre",
    "output_scope": "turn",
    "icon": "ğŸ“",
    "ai_config": {
        "mode": "current"
    },
    "settings_schema": {
        "min_length": {
            "type": "number",
            "label": "è¦ç´„ã™ã‚‹æœ€å°æ–‡å­—æ•°",
            "default": 500,
            "min": 100,
            "max": 2000
        }
    }
}

# summarizer/summarizer_supporter.py
def execute(context: dict) -> dict:
    user_input = context.get('user_input', '')
    settings = context.get('settings', {})
    ai_helper = context.get('ai_helper')
    
    min_length = settings.get('min_length', 500)
    
    # çŸ­ã„å…¥åŠ›ã¯ãã®ã¾ã¾è¿”ã™
    if len(user_input) < min_length:
        return {}
    
    # AIæ©Ÿèƒ½ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if not ai_helper:
        return {}
    
    try:
        summary = ai_helper.get_response(
            system_prompt="ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç°¡æ½”ã«è¦ç´„ã—ã¦ãã ã•ã„ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ç®‡æ¡æ›¸ãã§ç¤ºã—ã¦ãã ã•ã„ã€‚",
            user_message=user_input
        )
        
        return {
            'context_additions': f"## ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®è¦ç´„\n{summary}",
            'turn_data': {
                'original_length': len(user_input),
                'was_summarized': True
            }
        }
    
    except Exception as e:
        return {'error': f'è¦ç´„ã«å¤±æ•—: {e}'}

------------------------------------------------------------------------------
11.3 Postå‡¦ç†ã‚µãƒãƒ¼ã‚¿ãƒ¼ï¼ˆæ¤œé–²ï¼‰
------------------------------------------------------------------------------

# content_filter/manifest.json
{
    "name": "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼",
    "description": "ä¸é©åˆ‡ãªå†…å®¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™",
    "version": "1.0.0",
    "timing": "post",
    "output_scope": "temporary",
    "icon": "ğŸ›¡ï¸",
    "settings_schema": {
        "filter_level": {
            "type": "select",
            "label": "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¬ãƒ™ãƒ«",
            "default": "medium",
            "options": [
                {"value": "low", "label": "ä½"},
                {"value": "medium", "label": "ä¸­"},
                {"value": "high", "label": "é«˜"}
            ]
        }
    }
}

# content_filter/content_filter_supporter.py

BLOCKED_WORDS = {
    'low': ['word1'],
    'medium': ['word1', 'word2'],
    'high': ['word1', 'word2', 'word3']
}

def execute(context: dict) -> dict:
    if context['timing'] != 'post':
        return {}
    
    response = context.get('ai_response', '')
    settings = context.get('settings', {})
    level = settings.get('filter_level', 'medium')
    
    blocked = BLOCKED_WORDS.get(level, [])
    
    modified = response
    for word in blocked:
        modified = modified.replace(word, '[ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿]')
    
    if modified != response:
        return {'modified_response': modified}
    
    return {}

------------------------------------------------------------------------------
11.4 Pre/Postä¸¡æ–¹ã§å‹•ä½œã™ã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼
------------------------------------------------------------------------------

# analyzer/manifest.json
{
    "name": "ä¼šè©±åˆ†æã‚µãƒãƒ¼ã‚¿ãƒ¼",
    "description": "å…¥åŠ›ã¨å‡ºåŠ›ã‚’åˆ†æã—ã¦çµ±è¨ˆã‚’è¨˜éŒ²ã—ã¾ã™",
    "version": "1.0.0",
    "timing": "both",
    "output_scope": "permanent",
    "icon": "ğŸ“Š"
}

# analyzer/analyzer_supporter.py
import time

def execute(context: dict) -> dict:
    timing = context['timing']
    
    if timing == 'pre':
        return handle_pre(context)
    else:
        return handle_post(context)

def handle_pre(context: dict) -> dict:
    user_input = context.get('user_input', '')
    
    # å…¥åŠ›ã®çµ±è¨ˆã‚’turn_dataã«ä¿å­˜
    return {
        'turn_data': {
            'input_length': len(user_input),
            'input_word_count': len(user_input.split()),
            'start_time': time.time()
        }
    }

def handle_post(context: dict) -> dict:
    response = context.get('ai_response', '')
    turn_data = context.get('turn_data', {})
    
    start_time = turn_data.get('start_time', time.time())
    elapsed = time.time() - start_time
    
    # çµ±è¨ˆã‚’è¨ˆç®—
    stats = {
        'input_length': turn_data.get('input_length', 0),
        'input_word_count': turn_data.get('input_word_count', 0),
        'output_length': len(response),
        'output_word_count': len(response.split()),
        'processing_time': elapsed,
        'timestamp': time.time()
    }
    
    # æ°¸ç¶šä¿å­˜
    return {
        'permanent_data': {
            'last_stats': stats
        }
    }

================================================================================
                              ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçµ‚äº†
================================================================================
