================================================================================
Rumi AI - Docker Security System ドキュメント
================================================================================

目次
────────────────────────────────────────────────────────────────────────────────
1. 概要
2. アーキテクチャ
3. セキュリティモデル
4. ディレクトリ構造
5. 使用方法
6. 権限システム
7. ハンドラ
8. トラブルシューティング

================================================================================
1. 概要
================================================================================

Rumi AI Docker Security Systemは、Ecosystem内の各Packを完全に隔離された
Dockerコンテナで実行するセキュリティシステムです。

【設計原則】
- 全てのPackは信頼度ゼロとして扱う
- 各Packは独立したコンテナで実行（共有なし）
- ファイル/ネットワークアクセスは明示的な許可が必要
- 監査ログで全ての操作を記録

================================================================================
2. アーキテクチャ
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│                     Docker Host                                  │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Base Image (rumi-base:latest)                          │   │
│  │  - Python 3.11 Alpine                                    │   │
│  │  - 基本ツール (git, curl)                               │   │
│  │  - 信頼できる公式イメージ                               │   │
│  │  - 全コンテナで共有（読み取り専用レイヤー）             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│         ┌────────────────────┼────────────────────┐             │
│         ▼                    ▼                    ▼             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐     │
│  │ Pack A      │      │ Pack B      │      │ Pack C      │     │
│  │ Container   │      │ Container   │      │ Container   │     │
│  │             │      │             │      │             │     │
│  │ - 独自venv  │      │ - 独自venv  │      │ - 独自venv  │     │
│  │ - 独自依存  │      │ - 独自依存  │      │ - 独自依存  │     │
│  │ - 独自code  │      │ - 独自code  │      │ - 独自code  │     │
│  │             │      │             │      │             │     │
│  │ 完全隔離    │      │ 完全隔離    │      │ 完全隔離    │     │
│  └─────────────┘      └─────────────┘      └─────────────┘     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

【メモリ使用量】
- Base Image: ~60MB（全コンテナ共有）
- コンテナあたり: ~20-30MB（Pack固有レイヤー）
- 20 Pack の場合: 60MB + 20×25MB = ~560MB

================================================================================
3. セキュリティモデル
================================================================================

【信頼の境界】

  公式が提供（信頼できる）:
  ├── Docker Engine
  ├── Linux Kernel
  ├── Base Image (python:3.11-alpine)
  └── 基本ツール

  Packが提供（信頼度ゼロ）:
  ├── Pack のコード
  ├── Pack の requirements.txt
  └── Pack の依存ライブラリ

【隔離の保証】

  ✗ Pack A が Pack B のコードを読む    → 不可能（別コンテナ）
  ✗ Pack A が Pack B のメモリにアクセス → 不可能（別プロセス空間）
  ✗ Pack A が共有ライブラリを汚染     → 不可能（読取専用レイヤー）
  ✗ Pack A が Pack B のファイルを操作  → 不可能（別ボリューム）
  ✗ Pack A が Pack B のネットワークに介入 → 不可能（別ネットワーク）

================================================================================
4. ディレクトリ構造
================================================================================

docker/
├── base/
│   └── Dockerfile              # 共有ベースイメージ
│
├── packs/
│   ├── default/
│   │   └── Dockerfile          # Pack専用イメージ
│   └── {pack_id}/
│       └── Dockerfile
│
├── handlers/                   # 権限ハンドラ
│   ├── file_read.py
│   ├── file_write.py
│   ├── env_read.py
│   ├── terminal.py
│   └── network.py
│
├── scopes/                     # スコープ定義
│   ├── file_read.json
│   ├── file_write.json
│   ├── env_read.json
│   ├── terminal.json
│   └── network.json
│
├── grants/                     # 許可記録
│   └── {component_id}.json
│
├── sandbox/                    # 作業領域
│   └── {pack_id}/
│
├── docker-compose.yml
└── config.json

================================================================================
5. 使用方法
================================================================================

【初期セットアップ】

1. create_dockerfile.py を実行:
   python create_dockerfile.py

2. ベースイメージをビルド:
   docker build -t rumi-base:latest docker/base/

3. 全Packイメージをビルド:
   docker-compose -f docker/docker-compose.yml build

4. コンテナを起動:
   docker-compose -f docker/docker-compose.yml up -d

【コンテナ管理】

# 特定のPackを起動
docker-compose -f docker/docker-compose.yml up -d pack-default

# コンテナの状態確認
docker-compose -f docker/docker-compose.yml ps

# ログ確認
docker-compose -f docker/docker-compose.yml logs pack-default

# 停止
docker-compose -f docker/docker-compose.yml down

================================================================================
6. 権限システム
================================================================================

【権限の種類】

- file_read:  ファイル読み取り（許可ディレクトリのみ）
- file_write: ファイル書き込み（許可ディレクトリのみ）
- env_read:   環境変数読み取り（許可キーのみ）
- terminal:   ターミナル実行（許可ディレクトリ内のみ）
- network:    ネットワーク通信（許可ドメイン/ポートのみ）

【許可の付与】

docker/grants/{component_id}.json:
{
  "component_id": "default:tool:my_tool",
  "permissions": {
    "file_read": {
      "enabled": true,
      "directories": ["/home/user/documents"]
    },
    "env_read": {
      "enabled": true,
      "allowed_keys": ["OPENAI_API_KEY"]
    },
    "network": {
      "enabled": true,
      "allowed_domains": ["api.openai.com"],
      "allowed_ports": [443]
    }
  }
}

================================================================================
7. ハンドラ
================================================================================

【ハンドラの追加】

docker/handlers/ に Python ファイルを追加:

```python
# my_handler.py

META = {
    "requires_scope": True,
    "supports_modes": ["sandbox"],
    "description": "説明"
}

def execute(context: dict, args: dict) -> dict:
    # 処理
    return {"success": True, "data": ...}
```

【スコープの追加】

docker/scopes/ に JSON ファイルを追加:

```json
{
  "version": "1.0",
  "description": "スコープの説明",
  "default_config": {}
}
```

================================================================================
8. トラブルシューティング
================================================================================

【Dockerが起動しない】
- Docker Desktop が起動しているか確認
- `docker info` でDockerの状態を確認

【コンテナが起動しない】
- `docker-compose logs {service}` でログを確認
- Dockerfile の構文エラーを確認

【権限エラー】
- docker/grants/ に適切な許可ファイルがあるか確認
- 許可されたディレクトリ/キーが正しいか確認

【メモリ不足】
- `docker stats` でメモリ使用量を確認
- config.json の memory_limit を調整
- 不要なコンテナを停止

================================================================================
                              ドキュメント終わり
================================================================================
