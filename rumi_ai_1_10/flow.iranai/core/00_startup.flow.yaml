# flows/00_startup.flow.yaml
# Rumi OS起動Flow（正規）
#
# このファイルがOSブートの正式な定義です。
# 旧 flow/ ディレクトリは deprecated であり、fallback としてのみ使用されます。

flow_version: "2.0"
flow_id: "00_startup"
description: "Rumi OS startup flow - official boot sequence"

defaults:
  fail_soft: true
  on_missing_handler: skip

phases:
  - security
  - core
  - ecosystem
  - ready

steps:
  # === Security Phase ===
  - id: secret_key_load
    phase: security
    priority: 10
    type: handler
    input:
      handler: "kernel:secret_key.load"
      args:
        auto_generate: true

  - id: approval_scan
    phase: security
    priority: 20
    type: handler
    input:
      handler: "kernel:approval.scan"
      args:
        directories:
          - "ecosystem/packs"

  - id: egress_proxy_start
    phase: security
    priority: 40
    type: handler
    input:
      handler: "kernel:egress_proxy.start"
      args:
        auto_start: true

  # === Core Phase ===
  - id: vocab_load
    phase: core
    priority: 10
    type: handler
    input:
      handler: "kernel:vocab.load"
      args:
        sources:
          - "ecosystem/packs"

  - id: flow_loader_init
    phase: core
    priority: 20
    type: handler
    input:
      handler: "kernel:flow_loader.init"
      args:
        directories:
          - "flows"
          - "ecosystem/flows"

  - id: modifier_load
    phase: core
    priority: 30
    type: handler
    input:
      handler: "kernel:modifier.load"
      args:
        directories:
          - "ecosystem/flows/modifiers"

  # === Ecosystem Phase ===
  - id: pack_discovery
    phase: ecosystem
    priority: 10
    type: handler
    input:
      handler: "kernel:pack.discover"
      args:
        directories:
          - "ecosystem/packs"

  - id: pack_load
    phase: ecosystem
    priority: 20
    type: handler
    input:
      handler: "kernel:pack.load"
      args:
        filter:
          approved_only: true

  - id: interface_register
    phase: ecosystem
    priority: 30
    type: handler
    input:
      handler: "kernel:interface.register"
      args: {}

  # === Ready Phase ===
  - id: health_check
    phase: ready
    priority: 10
    type: handler
    input:
      handler: "kernel:health.check"
      args:
        components:
          - vocab
          - flow_loader
          - pack_manager

  - id: startup_complete
    phase: ready
    priority: 99
    type: handler
    input:
      handler: "kernel:startup.complete"
      args:
        emit_event: true
